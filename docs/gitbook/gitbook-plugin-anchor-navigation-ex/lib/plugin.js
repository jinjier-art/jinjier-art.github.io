var cheerio=require("cheerio"),slug=require("github-slugid"),Config=require("./config.js");function handlerTocs(t,r,i){var h=Config.config,o=[],c={h1:0,h2:0,h3:0},d={};return t(":header").each(function(e,l){var n=t(l),a=addId(n,d);if(a)switch(l.tagName){case"h1":handlerH1Toc(h,c,n,o,r.level,i);break;case"h2":handlerH2Toc(h,c,n,o,r.level,i);break;case"h3":handlerH3Toc(h,c,n,o,r.level,i);break;default:titleAddAnchor(n,a)}}),r.content=t.html(),o}function addId(e,l){var n=e.attr("id")||slug(e.text()),a=l[n]||0;return l[n]=a+1,e.attr("id",n=a?n+"_"+a:n),n}function titleAddAnchor(e,l){e.prepend('<a name="'+l+'" class="anchor-navigation-ex-anchor" href="#'+l+'"><i class="fa fa-link" aria-hidden="true"></i></a>')}function handlerH1Toc(e,l,n,a,t,r){var i=n.text(),h=n.attr("id"),o="";e.showLevel&&(l.h1+=1,l.h2=0,l.h3=0,o=e.multipleH1?l.h1+". ":" ",e.associatedWithSummary&&e.themeDefault.showLevel&&(o=t+"."+o),n.text((o=r?o:"")+i)),titleAddAnchor(n,h),a.push({name:i,level:o,url:h,children:[]})}function handlerH2Toc(e,l,n,a,t,r){var i=n.text(),h=n.attr("id"),o="",c=(a.length<=0&&(e.showLevel&&(l.h1+=1),a.push({name:"",level:"",url:"",children:[]})),a.length-1),a=a[c];e.showLevel&&(l.h2+=1,l.h3=0,o=e.multipleH1?l.h1+"."+l.h2+". ":l.h2+". ",e.associatedWithSummary&&e.themeDefault.showLevel&&(o=t+"."+o),n.text((o=r?o:"")+i)),titleAddAnchor(n,h),a.children.push({name:i,level:o,url:h,children:[]})}function handlerH3Toc(e,l,n,a,t,r){var i=n.text(),h=n.attr("id"),o="",c=(a.length<=0&&(e.showLevel&&(l.h1+=1),a.push({name:"",level:"",url:"",children:[]})),a.length-1),a=a[c],c=a.children,a=(c.length<=0&&(e.showLevel&&(l.h2+=1),c.push({name:"",level:"",url:"",children:[]})),a.children[c.length-1]);e.showLevel&&(l.h3+=1,o=e.multipleH1?l.h1+"."+l.h2+"."+l.h3+". ":l.h2+"."+l.h3+". ",e.associatedWithSummary&&e.themeDefault.showLevel&&(o=t+"."+o),n.text((o=r?o:"")+i)),titleAddAnchor(n,h),a.children.push({name:i,level:o,url:h,children:[]})}function handlerFloatNavbar(e,l){for(var n=Config.config.float,a=n.floatIcon,t="",r="",i="",h=(n.showLevelIcon&&(t=n.level1Icon,r=n.level2Icon,i=n.level3Icon),"<div id='anchor-navigation-ex-navbar'><i class='"+a+"'></i><ul>"),o=0;o<l.length;o++){var c=l[o];if(c.name&&(h+="<li><span class='title-icon "+t+"'></span><a href='#"+c.url+"'><b>"+c.level+"</b>"+c.name+"</a></li>"),0<c.children.length){h+="<ul>";for(var d=0;d<c.children.length;d++){var u=c.children[d];if(u.name&&(h+="<li><span class='title-icon "+r+"'></span><a href='#"+u.url+"'><b>"+u.level+"</b>"+u.name+"</a></li>"),0<u.children.length){h+="<ul>";for(var v=0;v<u.children.length;v++){var s=u.children[v];h+="<li><span class='title-icon "+i+"'></span><a href='#"+s.url+"'><b>"+s.level+"</b>"+s.name+"</a></li>"}h+="</ul>"}}h+="</ul>"}}return h+="</ul></div>"}function handlerPageTopNavbar(e,l){return buildTopNavbar(e,l)}function buildTopNavbar(e,l){for(var n=Config.config.pageTop,a="",t="",r="",i=(n.showLevelIcon&&(a=n.level1Icon,t=n.level2Icon,r=n.level3Icon),"<div id='anchor-navigation-ex-pagetop-navbar'><ul>"),h=0;h<l.length;h++){var o=l[h];if(o.name&&(i+="<li><span class='title-icon "+a+"'></span><a href='#"+o.url+"'><b>"+o.level+"</b>"+o.name+"</a></li>"),0<o.children.length){i+="<ul>";for(var c=0;c<o.children.length;c++){var d=o.children[c];if(d.name&&(i+="<li><span class='title-icon "+t+"'></span><a href='#"+d.url+"'><b>"+d.level+"</b>"+d.name+"</a></li>"),0<d.children.length){i+="<ul>";for(var u=0;u<d.children.length;u++){var v=d.children[u];i+="<li><span class='title-icon "+r+"'></span><a href='#"+v.url+"'><b>"+v.level+"</b>"+v.name+"</a></li>"}i+="</ul>"}}i+="</ul>"}}return i+="</ul></div>"}function buildGoTop(e){var l="";return l=Config.config.showGoTop&&e&&0<e.length?"<a href='#"+e[0].url+"' id='anchorNavigationExGoTop'><i class='fa fa-arrow-up'></i></a>":l}function start(e,l){var n,a,t=cheerio.load(l.content),r=handlerTocs(t,l,!/<!--[ \t]*ex_nolevel[ \t]*-->/.test(l.content));0==r.length?l.content=t.html():(n="",/<!--[ \t]*ex_nonav[ \t]*-->/.test(l.content)||("float"==(a=Config.config.mode)?n=handlerFloatNavbar(t,r):"pageTop"==a&&(n=handlerPageTopNavbar(t,r))),n+=buildGoTop(r),l.content=n+t.html(),(a=cheerio.load(l.content))("extoc").replaceWith(a(buildTopNavbar(t,r,l))),l.content=a.html())}module.exports=start;